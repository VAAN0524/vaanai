<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€éšç§ä¿æŠ¤æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8f9fa;
            line-height: 1.6;
        }
        .test-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 14px;
        }
        button:hover { background: #5a67d8; }
        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid #e9ecef;
        }
        .message-demo {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #667eea;
        }
        .message-demo .author {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        .message-demo .content {
            color: #333;
            line-height: 1.5;
        }
        .privacy-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 0.5rem;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }
        .comparison-item {
            padding: 1rem;
            border-radius: 6px;
        }
        .before {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }
        .after {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        .comparison-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .test-form {
            display: grid;
            gap: 1rem;
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        input, textarea {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”’ æç®€éšç§ä¿æŠ¤æµ‹è¯•</h1>
        <p>éªŒè¯ç•™è¨€ç³»ç»Ÿæ˜¯å¦åªæ˜¾ç¤ºå¿…è¦ä¿¡æ¯ï¼ˆæ˜µç§°+ç•™è¨€å†…å®¹ï¼‰</p>

        <div id="testResults"></div>

        <button onclick="runMinimalPrivacyTest()">ğŸ§ª è¿è¡Œæç®€éšç§æµ‹è¯•</button>
        <button onclick="testDataCleanup()">ğŸ§¹ æµ‹è¯•æ•°æ®æ¸…ç†</button>
        <button onclick="testGitHubMinimalFormat()">ğŸ™ æµ‹è¯•GitHubæç®€æ ¼å¼</button>
        <button onclick="simulateOldMessage()">ğŸ“ æ¨¡æ‹Ÿæ—§ç•™è¨€æ•°æ®</button>
        <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
    </div>

    <div class="test-container">
        <h2>ğŸ“Š éšç§ä¿æŠ¤æ•ˆæœå¯¹æ¯”</h2>
        <div class="comparison">
            <div class="comparison-item before">
                <div class="comparison-title">ğŸ”“ ä¹‹å‰ï¼ˆæ³„éœ²éšç§ï¼‰</div>
                <div class="message-demo">
                    <div class="author">ç”µè„‘ç½‘é¡µç”¨æˆ·</div>
                    <div class="content">111111111</div>
                    <div style="font-size: 12px; color: #666; margin-top: 0.5rem;">
                        ğŸ“ Wuhan, China | ğŸ• 2025-10-29 12:09 | ğŸŒ IP: ***
                    </div>
                </div>
            </div>
            <div class="comparison-item after">
                <div class="comparison-title">ğŸ”’ ç°åœ¨ï¼ˆæç®€éšç§ï¼‰</div>
                <div class="message-demo">
                    <div class="author">ç”µè„‘ç½‘é¡µç”¨æˆ· <span class="privacy-badge">éšç§ä¿æŠ¤</span></div>
                    <div class="content">111111111</div>
                </div>
            </div>
        </div>
    </div>

    <div class="test-container">
        <h2>ğŸ“ ç•™è¨€åŠŸèƒ½æµ‹è¯•</h2>
        <div class="test-form">
            <div class="form-group">
                <label>æ˜µç§°:</label>
                <input type="text" id="testName" placeholder="æµ‹è¯•ç”¨æˆ·" maxlength="20">
            </div>
            <div class="form-group">
                <label>ç•™è¨€:</label>
                <textarea id="testMessage" placeholder="è¿™æ˜¯ä¸€æ¡æµ‹è¯•ç•™è¨€..." maxlength="500" rows="3"></textarea>
            </div>
            <button onclick="testMinimalMessage()">ğŸ“¤ æäº¤æç®€ç•™è¨€æµ‹è¯•</button>
        </div>

        <div id="messagePreview"></div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="js/github-sync.js"></script>
    <script src="js/cloudflare-sync.js"></script>
    <script src="config-helper.js"></script>

    <script>
        let testResults = [];

        function addTestResult(type, title, content) {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `status ${type}`;

            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML = `
                <strong>[${timestamp}] ${title}</strong>
                ${content ? `<pre>${JSON.stringify(content, null, 2)}</pre>` : ''}
            `;

            results.appendChild(div);
            testResults.push({ type, title, content, timestamp });
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            testResults = [];
        }

        // æ¨¡æ‹Ÿæ¸…ç†æ—§éšç§æ•°æ®
        function testCleanupOldPrivacyData() {
            console.log('ğŸ§¹ å¼€å§‹æµ‹è¯•æ¸…ç†æ—§çš„éšç§æ•°æ®...');

            // åˆ›å»ºåŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ¨¡æ‹Ÿæ—§æ•°æ®
            const oldSensitiveData = [
                {
                    id: '1',
                    name: 'æµ‹è¯•ç”¨æˆ·1',
                    text: 'è¿™æ˜¯åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ—§ç•™è¨€',
                    time: '2025-10-29 10:00',
                    location: 'Beijing, China',
                    ip: '192.168.1.100',
                    userAgent: 'Mozilla/5.0 (Test Browser)'
                },
                {
                    id: '2',
                    name: 'æµ‹è¯•ç”¨æˆ·2',
                    text: 'è¿™æ˜¯å¦ä¸€æ¡æ—§ç•™è¨€',
                    time: '2025-10-29 11:00',
                    location: 'Shanghai, China',
                    ip: '192.168.1.101',
                    userAgent: 'Chrome/91.0'
                }
            ];

            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('messages', JSON.stringify(oldSensitiveData));
            console.log('ğŸ“¦ å·²ä¿å­˜æ¨¡æ‹Ÿçš„æ•æ„Ÿæ•°æ®åˆ°localStorage');

            // æ£€æµ‹æ•æ„Ÿä¿¡æ¯
            const hasSensitiveData = oldSensitiveData.some(msg =>
                msg.location || msg.ip || msg.userAgent
            );

            if (hasSensitiveData) {
                localStorage.removeItem('messages');
                console.log('âœ… å·²æ¸…ç†åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ—§ç•™è¨€æ•°æ®');
                return true;
            }

            return false;
        }

        async function testDataCleanup() {
            addTestResult('info', 'ğŸ§¹ å¼€å§‹æµ‹è¯•æ•°æ®æ¸…ç†åŠŸèƒ½...', '');

            // æ¨¡æ‹Ÿä¿å­˜æ•æ„Ÿæ•°æ®
            const cleaned = testCleanupOldPrivacyData();

            if (cleaned) {
                addTestResult('success', 'âœ… æ•°æ®æ¸…ç†åŠŸèƒ½æ­£å¸¸', {
                    sensitiveDataDetected: true,
                    dataCleaned: true,
                    localStorageMessages: localStorage.getItem('messages') === null
                });
            } else {
                addTestResult('warning', 'âš ï¸ æœªæ£€æµ‹åˆ°æ•æ„Ÿæ•°æ®', 'æ¸…ç†åŠŸèƒ½æœªè§¦å‘');
            }

            // æµ‹è¯•GitHubç¼“å­˜æ¸…ç†
            localStorage.setItem('github_issues_cache', 'test-cache-data');
            const hadCache = localStorage.getItem('github_issues_cache') !== null;

            if (hadCache) {
                localStorage.removeItem('github_issues_cache');
                addTestResult('success', 'âœ… GitHubç¼“å­˜æ¸…ç†æˆåŠŸ', {
                    cacheExisted: true,
                    cacheCleaned: localStorage.getItem('github_issues_cache') === null
                });
            } else {
                addTestResult('info', 'â„¹ï¸ æ— GitHubç¼“å­˜éœ€è¦æ¸…ç†', '');
            }
        }

        async function testGitHubMinimalFormat() {
            addTestResult('info', 'ğŸ™ å¼€å§‹æµ‹è¯•GitHubæç®€æ ¼å¼...', '');

            if (typeof GitHubIssuesSync !== 'undefined') {
                const token = localStorage.getItem('github_token');
                const repo = localStorage.getItem('github_repo');

                if (token && repo) {
                    const sync = new GitHubIssuesSync(repo, token);

                    // åˆ›å»ºæµ‹è¯•æ¶ˆæ¯
                    const testMessage = {
                        name: 'æç®€æµ‹è¯•ç”¨æˆ·',
                        text: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æç®€éšç§ä¿æŠ¤çš„ç•™è¨€',
                        time: new Date().toLocaleString('zh-CN'),
                        location: 'Test Location',
                        ip: '192.168.1.100',
                        userAgent: 'Test Browser Agent'
                    };

                    // æµ‹è¯•æç®€æ ¼å¼åŒ–
                    const formattedBody = sync.formatIssueBody(testMessage);

                    addTestResult('success', 'âœ… GitHubæç®€æ ¼å¼åŒ–æµ‹è¯•', {
                        originalMessage: {
                            name: testMessage.name,
                            text: testMessage.text,
                            hasLocation: !!testMessage.location,
                            hasIP: !!testMessage.ip,
                            hasUserAgent: !!testMessage.userAgent
                        },
                        formattedBody: formattedBody,
                        privacyFeatures: [
                            'åªä¿ç•™ç•™è¨€å†…å®¹',
                            'ç§»é™¤æ‰€æœ‰å…ƒæ•°æ®',
                            'ç§»é™¤åœ°ç†ä½ç½®',
                            'ç§»é™¤IPåœ°å€',
                            'ç§»é™¤ç”¨æˆ·ä»£ç†',
                            'ç§»é™¤æ—¶é—´æˆ³'
                        ]
                    });

                    // éªŒè¯æ ¼å¼åŒ–ç»“æœ
                    const onlyContainsText = formattedBody === testMessage.text;
                    const hasNoMetadata = !formattedBody.includes('**') &&
                                        !formattedBody.includes('æ—¶é—´:') &&
                                        !formattedBody.includes('åœ°ç‚¹:') &&
                                        !formattedBody.includes('IP:') &&
                                        !formattedBody.includes('User-Agent');

                    if (onlyContainsText && hasNoMetadata) {
                        addTestResult('success', 'âœ… æç®€éšç§éªŒè¯é€šè¿‡', {
                            onlyContainsText: onlyContainsText,
                            noMetadata: hasNoMetadata,
                            privacyLevel: 'MAXIMUM'
                        });
                    } else {
                        addTestResult('error', 'âŒ æç®€éšç§éªŒè¯å¤±è´¥', {
                            onlyContainsText: onlyContainsText,
                            noMetadata: hasNoMetadata
                        });
                    }

                    // æµ‹è¯•è§£æåŠŸèƒ½
                    const mockIssue = {
                        id: 12345,
                        title: 'ç•™è¨€ - æç®€æµ‹è¯•ç”¨æˆ·',
                        body: testMessage.text,
                        created_at: new Date().toISOString(),
                        html_url: 'https://github.com/test/test/issues/12345'
                    };

                    const parsedMessage = sync.parseIssueToMessage(mockIssue);

                    addTestResult('success', 'âœ… GitHubè§£ææµ‹è¯•', {
                        parsedMessage: {
                            name: parsedMessage.name,
                            text: parsedMessage.text,
                            hasTime: !!parsedMessage.time,
                            hasLocation: !!parsedMessage.location,
                            hasIP: !!parsedMessage.ip
                        },
                        privacyProtected: !parsedMessage.location && !parsedMessage.ip
                    });

                } else {
                    addTestResult('error', 'âŒ ç¼ºå°‘GitHubé…ç½®', 'è¯·å…ˆé…ç½®GitHub tokenå’Œrepo');
                }
            } else {
                addTestResult('error', 'âŒ GitHubIssuesSyncæœªåŠ è½½', 'æ— æ³•æµ‹è¯•GitHubåŠŸèƒ½');
            }
        }

        async function simulateOldMessage() {
            addTestResult('info', 'ğŸ“ æ¨¡æ‹Ÿåˆ›å»ºæ—§çš„éšç§æ•°æ®...', '');

            const oldMessage = {
                id: Date.now().toString(),
                name: 'æ—§ç”¨æˆ·',
                text: 'è¿™æ˜¯ä¸€æ¡åŒ…å«éšç§ä¿¡æ¯çš„æ—§ç•™è¨€',
                time: new Date().toLocaleString('zh-CN'),
                location: 'Wuhan, China',
                ip: '123.456.789.0',
                userAgent: 'Mozilla/5.0 (Old Browser)',
                isOld: true
            };

            // ä¿å­˜åˆ°localStorage
            let messages = [];
            try {
                const stored = localStorage.getItem('messages');
                if (stored) {
                    messages = JSON.parse(stored);
                }
                messages.push(oldMessage);
                localStorage.setItem('messages', JSON.stringify(messages));
            } catch (error) {
                localStorage.setItem('messages', JSON.stringify([oldMessage]));
            }

            addTestResult('success', 'âœ… æ—§éšç§æ•°æ®å·²åˆ›å»º', {
                messageCreated: true,
                containsLocation: !!oldMessage.location,
                containsIP: !!oldMessage.ip,
                containsUserAgent: !!oldMessage.userAgent,
                totalMessages: messages.length
            });

            addTestResult('warning', 'âš ï¸ åˆ·æ–°é¡µé¢å°†è§¦å‘æ•°æ®æ¸…ç†', 'ä¸‹æ¬¡é¡µé¢åŠ è½½æ—¶ä¼šè‡ªåŠ¨æ¸…ç†è¿™äº›æ•æ„Ÿæ•°æ®');
        }

        async function testMinimalMessage() {
            const name = document.getElementById('testName').value.trim() || 'æç®€æµ‹è¯•ç”¨æˆ·';
            const message = document.getElementById('testMessage').value.trim() || 'è¿™æ˜¯ä¸€æ¡æç®€éšç§ä¿æŠ¤çš„æµ‹è¯•ç•™è¨€';

            addTestResult('info', 'ğŸ“¤ å¼€å§‹æµ‹è¯•æç®€ç•™è¨€æäº¤...', '');

            // æ˜¾ç¤ºæç®€ç•™è¨€é¢„è§ˆ
            const preview = document.getElementById('messagePreview');
            preview.innerHTML = `
                <h3>ğŸ“‹ æç®€ç•™è¨€é¢„è§ˆ</h3>
                <div class="message-demo">
                    <div class="author">${name} <span class="privacy-badge">æç®€éšç§</span></div>
                    <div class="content">${message}</div>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: #e8f5e8; border-radius: 6px;">
                    <strong>ğŸ”’ éšç§ä¿æŠ¤çŠ¶æ€ï¼š</strong><br>
                    âœ… å·²éšè—åœ°ç†ä½ç½®<br>
                    âœ… å·²éšè—IPåœ°å€<br>
                    âœ… å·²éšè—æµè§ˆå™¨ä¿¡æ¯<br>
                    âœ… å·²éšè—è¯¦ç»†æ—¶é—´<br>
                    âœ… åªæ˜¾ç¤ºæ˜µç§°å’Œå†…å®¹
                </div>
            `;

            addTestResult('success', 'âœ… æç®€ç•™è¨€æ ¼å¼éªŒè¯é€šè¿‡', {
                name: name,
                contentLength: message.length,
                privacyLevel: 'MAXIMUM',
                visibleInfo: ['æ˜µç§°', 'ç•™è¨€å†…å®¹'],
                hiddenInfo: ['åœ°ç†ä½ç½®', 'IPåœ°å€', 'æµè§ˆå™¨ä¿¡æ¯', 'è¯¦ç»†æ—¶é—´']
            });
        }

        async function runMinimalPrivacyTest() {
            clearResults();
            addTestResult('info', 'ğŸ§ª å¼€å§‹è¿è¡Œæç®€éšç§ä¿æŠ¤æµ‹è¯•...', '');

            await new Promise(resolve => setTimeout(resolve, 500));
            await testDataCleanup();

            await new Promise(resolve => setTimeout(resolve, 1000));
            await testGitHubMinimalFormat();

            addTestResult('success', 'ğŸ‰ æç®€éšç§ä¿æŠ¤æµ‹è¯•å®Œæˆ', {
                totalTests: testResults.length,
                successCount: testResults.filter(r => r.type === 'success').length,
                errorCount: testResults.filter(r => r.type === 'error').length,
                warningCount: testResults.filter(r => r.type === 'warning').length,
                privacyLevel: 'MAXIMUM',
                features: [
                    'åªæ˜¾ç¤ºæ˜µç§°å’Œç•™è¨€å†…å®¹',
                    'è‡ªåŠ¨æ¸…ç†æ•æ„Ÿæ•°æ®',
                    'æç®€GitHub Issueæ ¼å¼',
                    'æ— åœ°ç†ä½ç½®æ³„éœ²',
                    'æ— IPåœ°å€æ³„éœ²',
                    'æ— æµè§ˆå™¨ä¿¡æ¯æ³„éœ²'
                ]
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåç­‰å¾…è„šæœ¬åˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(() => {
                addTestResult('info', 'ğŸš€ æç®€éšç§æµ‹è¯•é¡µé¢å·²åŠ è½½', 'å¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
                runMinimalPrivacyTest();
            }, 2000);
        });
    </script>
</body>
</html>
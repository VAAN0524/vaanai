<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…ç†GitHubç•™è¨€</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8f9fa;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 14px;
        }
        button:hover { background: #c82333; }
        button.safe {
            background: #667eea;
        }
        button.safe:hover { background: #5a67d8; }
        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid #e9ecef;
        }
        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
        }
        .warning-box h3 {
            color: #856404;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§¹ æ¸…ç†GitHubç•™è¨€Issues</h1>

        <div class="warning-box">
            <h3>âš ï¸ å±é™©æ“ä½œè­¦å‘Š</h3>
            <p>æ­¤æ“ä½œå°†<strong>æ°¸ä¹…åˆ é™¤</strong>GitHubä»“åº“ä¸­çš„æ‰€æœ‰ç•™è¨€Issuesï¼ŒåŒ…æ‹¬ï¼š</p>
            <ul>
                <li>æ‰€æœ‰è®¿å®¢ç•™è¨€</li>
                <li>æ‰€æœ‰ç›¸å…³è¯„è®ºå’Œè®¨è®º</li>
                <li>æ‰€æœ‰å†å²æ•°æ®è®°å½•</li>
            </ul>
            <p><strong>æ­¤æ“ä½œä¸å¯æ¢å¤ï¼</strong>è¯·ç¡®è®¤æ‚¨çœŸçš„è¦åˆ é™¤æ‰€æœ‰ç•™è¨€ã€‚</p>
        </div>

        <div id="results"></div>

        <div style="margin: 2rem 0;">
            <button onclick="listIssues()" class="safe">ğŸ“‹ å…ˆæŸ¥çœ‹ç°æœ‰Issues</button>
            <button onclick="confirmCleanup()" style="background: #dc3545;">ğŸ—‘ï¸ ç¡®è®¤åˆ é™¤æ‰€æœ‰ç•™è¨€</button>
            <button onclick="clearResults()" class="safe">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
        </div>
    </div>

    <script>
        const GITHUB_TOKEN = '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';
        const GITHUB_REPO = 'VAAN0524/test';
        const API_BASE = 'https://api.github.com';

        function addResult(type, title, content) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;

            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML = `
                <strong>[${timestamp}] ${title}</strong>
                ${content ? `<pre>${JSON.stringify(content, null, 2)}</pre>` : ''}
            `;

            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function listIssues() {
            addResult('info', 'ğŸ“‹ å¼€å§‹è·å–ç°æœ‰ç•™è¨€Issues...', '');

            try {
                const response = await fetch(
                    `${API_BASE}/repos/${GITHUB_REPO}/issues?labels=ç•™è¨€&state=all&sort=created&direction=desc`,
                    {
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'User-Agent': 'Vaan-Cleanup-Tool/1.0'
                        }
                    }
                );

                if (response.ok) {
                    const issues = await response.json();

                    addResult('info', `ğŸ“Š æ‰¾åˆ° ${issues.length} ä¸ªç•™è¨€Issues`, {
                        total: issues.length,
                        open: issues.filter(i => i.state === 'open').length,
                        closed: issues.filter(i => i.state === 'closed').length
                    });

                    if (issues.length > 0) {
                        addResult('warning', 'âš ï¸ ä»¥ä¸‹Issueså°†è¢«åˆ é™¤ï¼š',
                            issues.map(issue => ({
                                number: issue.number,
                                title: issue.title,
                                state: issue.state,
                                created_at: issue.created_at,
                                author: issue.user.login
                            }))
                        );
                    } else {
                        addResult('success', 'âœ… æ²¡æœ‰æ‰¾åˆ°ç•™è¨€Issues', 'æ— éœ€åˆ é™¤');
                    }

                } else {
                    addResult('error', 'âŒ è·å–Issueså¤±è´¥', {
                        status: response.status,
                        statusText: response.statusText
                    });
                }
            } catch (error) {
                addResult('error', 'âŒ ç½‘ç»œé”™è¯¯', error.message);
            }
        }

        async function confirmCleanup() {
            const userConfirmed = confirm('âš ï¸ ç¡®è®¤è¦åˆ é™¤æ‰€æœ‰ç•™è¨€Issueså—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼\n\nç‚¹å‡»"ç¡®å®š"ç»§ç»­åˆ é™¤ï¼Œç‚¹å‡»"å–æ¶ˆ"åœæ­¢æ“ä½œã€‚');

            if (!userConfirmed) {
                addResult('info', 'â„¹ï¸ æ“ä½œå·²å–æ¶ˆ', 'ç”¨æˆ·å–æ¶ˆäº†åˆ é™¤æ“ä½œ');
                return;
            }

            const doubleConfirm = confirm('âš ï¸ æœ€åç¡®è®¤ï¼š\n\næ‚¨å³å°†åˆ é™¤GitHubä»“åº“ä¸­çš„æ‰€æœ‰ç•™è¨€Issuesã€‚\n\nå†æ¬¡ç‚¹å‡»"ç¡®å®š"æ‰§è¡Œåˆ é™¤æ“ä½œã€‚');

            if (!doubleConfirm) {
                addResult('info', 'â„¹ï¸ æ“ä½œå·²å–æ¶ˆ', 'ç”¨æˆ·åœ¨äºŒæ¬¡ç¡®è®¤ä¸­å–æ¶ˆäº†åˆ é™¤æ“ä½œ');
                return;
            }

            await cleanupAllIssues();
        }

        async function cleanupAllIssues() {
            addResult('info', 'ğŸ—‘ï¸ å¼€å§‹åˆ é™¤æ‰€æœ‰ç•™è¨€Issues...', '');

            try {
                // è·å–æ‰€æœ‰ç•™è¨€Issues
                const response = await fetch(
                    `${API_BASE}/repos/${GITHUB_REPO}/issues?labels=ç•™è¨€&state=all&per_page=100`,
                    {
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'User-Agent': 'Vaan-Cleanup-Tool/1.0'
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`è·å–Issueså¤±è´¥: ${response.status}`);
                }

                const issues = await response.json();
                addResult('info', `ğŸ“Š å‡†å¤‡åˆ é™¤ ${issues.length} ä¸ªIssues`, '');

                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                // é€ä¸ªåˆ é™¤Issues
                for (const issue of issues) {
                    try {
                        // æ›´æ–°IssueçŠ¶æ€ä¸ºclosedï¼ˆå…ˆå…³é—­ï¼‰
                        const closeResponse = await fetch(
                            `${API_BASE}/repos/${GITHUB_REPO}/issues/${issue.number}`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'Authorization': `token ${GITHUB_TOKEN}`,
                                    'Content-Type': 'application/json',
                                    'User-Agent': 'Vaan-Cleanup-Tool/1.0'
                                },
                                body: JSON.stringify({
                                    state: 'closed'
                                })
                            }
                        );

                        if (closeResponse.ok) {
                            addResult('success', `âœ… Issue #${issue.number} å·²å…³é—­`, {
                                title: issue.title,
                                author: issue.user.login
                            });
                        } else {
                            throw new Error(`å…³é—­å¤±è´¥: ${closeResponse.status}`);
                        }

                        // ç­‰å¾…ä¸€å°æ®µæ—¶é—´é¿å…APIé™åˆ¶
                        await new Promise(resolve => setTimeout(resolve, 500));

                        successCount++;
                    } catch (error) {
                        errorCount++;
                        errors.push({
                            number: issue.number,
                            title: issue.title,
                            error: error.message
                        });

                        addResult('error', `âŒ Issue #${issue.number} å¤„ç†å¤±è´¥`, {
                            title: issue.title,
                            error: error.message
                        });
                    }
                }

                // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                addResult('success', 'ğŸ‰ æ¸…ç†æ“ä½œå®Œæˆ', {
                    total: issues.length,
                    success: successCount,
                    errors: errorCount,
                    errorDetails: errors
                });

                if (errorCount === 0) {
                    addResult('success', 'âœ… æ‰€æœ‰ç•™è¨€Issueså·²æˆåŠŸå…³é—­', 'ç°åœ¨å¯ä»¥å¼€å§‹æ–°çš„ç•™è¨€åŠŸèƒ½äº†ï¼');
                } else {
                    addResult('warning', 'âš ï¸ éƒ¨åˆ†Issueså¤„ç†å¤±è´¥', 'è¯·æ£€æŸ¥é”™è¯¯è¯¦æƒ…å¹¶æ‰‹åŠ¨å¤„ç†å¤±è´¥çš„Issues');
                }

                // æ¸…ç†æœ¬åœ°ç¼“å­˜
                localStorage.removeItem('messages');
                localStorage.removeItem('github_issues_cache');
                addResult('info', 'ğŸ§¹ æœ¬åœ°ç¼“å­˜å·²æ¸…ç†', '');

            } catch (error) {
                addResult('error', 'âŒ æ¸…ç†æ“ä½œå¤±è´¥', error.message);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åˆ—å‡ºç°æœ‰Issues
        window.addEventListener('load', () => {
            setTimeout(listIssues, 1000);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹³è¡¡éšç§ä¿æŠ¤æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8f9fa;
            line-height: 1.6;
        }
        .test-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 14px;
        }
        button:hover { background: #5a67d8; }
        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid #e9ecef;
        }
        .message-demo {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #667eea;
        }
        .message-demo .author {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        .message-demo .info {
            font-size: 12px;
            color: #666;
            margin-bottom: 0.5rem;
        }
        .message-demo .content {
            color: #333;
            line-height: 1.5;
        }
        .privacy-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 0.5rem;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }
        .comparison-item {
            padding: 1rem;
            border-radius: 6px;
        }
        .before {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }
        .after {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        .comparison-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .test-form {
            display: grid;
            gap: 1rem;
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        input, textarea {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .feature-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        .feature-item {
            padding: 0.5rem;
            background: #e8f5e8;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>âš–ï¸ å¹³è¡¡éšç§ä¿æŠ¤æµ‹è¯•</h1>
        <p>æµ‹è¯•å¹³è¡¡çš„éšç§ä¿æŠ¤ï¼šæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯ä½†é¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²</p>

        <div id="testResults"></div>

        <button onclick="runBalancedPrivacyTest()">ğŸ§ª è¿è¡Œå¹³è¡¡éšç§æµ‹è¯•</button>
        <button onclick="testGitHubFormat()">ğŸ™ æµ‹è¯•GitHubæ ¼å¼</button>
        <button onclick="testDisplayFormat()">ğŸ“± æµ‹è¯•æ˜¾ç¤ºæ ¼å¼</button>
        <button onclick="simulateNewMessage()">ğŸ“ æ¨¡æ‹Ÿæ–°ç•™è¨€</button>
        <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
    </div>

    <div class="test-container">
        <h2>ğŸ“Š å¹³è¡¡éšç§æ•ˆæœå±•ç¤º</h2>
        <div class="message-demo">
            <div class="author">æ‰‹æœºç”¨æˆ· <span class="privacy-badge">å¹³è¡¡éšç§</span></div>
            <div class="info">åšä¸ªæµ‹è¯• Â· 2025-10-29 12:30</div>
            <div class="content">è¿™æ˜¯ä¸€æ¡æµ‹è¯•ç•™è¨€ï¼Œæ˜¾ç¤ºäº†åŸºæœ¬çš„æ—¶é—´å’Œåœ°åŸŸä¿¡æ¯ï¼Œä½†éšè—äº†IPåœ°å€ç­‰æ•æ„Ÿæ•°æ®ã€‚</div>
        </div>

        <h3>ğŸ”’ éšç§ä¿æŠ¤ç‰¹æ€§</h3>
        <div class="feature-list">
            <div class="feature-item">âœ… æ˜¾ç¤ºæ˜µç§°</div>
            <div class="feature-item">âœ… æ˜¾ç¤ºç•™è¨€å†…å®¹</div>
            <div class="feature-item">âœ… æ˜¾ç¤ºåœ°ç†ä½ç½®</div>
            <div class="feature-item">âœ… æ˜¾ç¤ºæ—¶é—´</div>
            <div class="feature-item">ğŸ”’ éšè—IPåœ°å€</div>
            <div class="feature-item">ğŸ”’ éšè—æµè§ˆå™¨ä¿¡æ¯</div>
            <div class="feature-item">ğŸ”’ æ— æ•æ„Ÿæç¤º</div>
            <div class="feature-item">ğŸ”’ æ•°æ®å®‰å…¨å­˜å‚¨</div>
        </div>
    </div>

    <div class="test-container">
        <h2>ğŸ“ ç•™è¨€åŠŸèƒ½æµ‹è¯•</h2>
        <div class="test-form">
            <div class="form-group">
                <label>æ˜µç§°:</label>
                <input type="text" id="testName" placeholder="æ‰‹æœºç”¨æˆ·" maxlength="20">
            </div>
            <div class="form-group">
                <label>ç•™è¨€:</label>
                <textarea id="testMessage" placeholder="åšä¸ªæµ‹è¯•" maxlength="500" rows="3"></textarea>
            </div>
            <button onclick="testBalancedMessage()">ğŸ“¤ æäº¤å¹³è¡¡éšç§ç•™è¨€</button>
        </div>

        <div id="messagePreview"></div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="js/github-sync.js"></script>
    <script src="js/cloudflare-sync.js"></script>
    <script src="config-helper.js"></script>

    <script>
        let testResults = [];

        function addTestResult(type, title, content) {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `status ${type}`;

            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML = `
                <strong>[${timestamp}] ${title}</strong>
                ${content ? `<pre>${JSON.stringify(content, null, 2)}</pre>` : ''}
            `;

            results.appendChild(div);
            testResults.push({ type, title, content, timestamp });
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            testResults = [];
        }

        async function testGitHubFormat() {
            addTestResult('info', 'ğŸ™ å¼€å§‹æµ‹è¯•GitHubå¹³è¡¡æ ¼å¼...', '');

            if (typeof GitHubIssuesSync !== 'undefined') {
                const token = localStorage.getItem('github_token');
                const repo = localStorage.getItem('github_repo');

                if (token && repo) {
                    const sync = new GitHubIssuesSync(repo, token);

                    // åˆ›å»ºæµ‹è¯•æ¶ˆæ¯
                    const testMessage = {
                        name: 'å¹³è¡¡æµ‹è¯•ç”¨æˆ·',
                        text: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•å¹³è¡¡éšç§ä¿æŠ¤çš„ç•™è¨€',
                        time: new Date().toLocaleString('zh-CN'),
                        location: 'Beijing, China',
                        ip: '192.168.1.100'
                    };

                    // æµ‹è¯•å¹³è¡¡æ ¼å¼åŒ–
                    const formattedBody = sync.formatIssueBody(testMessage);

                    addTestResult('success', 'âœ… GitHubå¹³è¡¡æ ¼å¼åŒ–æµ‹è¯•', {
                        originalMessage: {
                            name: testMessage.name,
                            text: testMessage.text,
                            location: testMessage.location
                        },
                        formattedBody: formattedBody,
                        privacyFeatures: [
                            'ä¿ç•™æ˜µç§°å’Œå†…å®¹',
                            'ä¿ç•™åœ°ç†ä½ç½®',
                            'ä¿ç•™æ—¶é—´ä¿¡æ¯',
                            'ç§»é™¤IPåœ°å€',
                            'ç»“æ„åŒ–å­˜å‚¨'
                        ]
                    });

                    // éªŒè¯æ ¼å¼åŒ–ç»“æœ
                    const hasName = formattedBody.includes('**æ˜µç§°:**');
                    const hasTime = formattedBody.includes('**æ—¶é—´:**');
                    const hasLocation = formattedBody.includes('**åœ°ç‚¹:**');
                    const hasContent = formattedBody.includes('### ç•™è¨€å†…å®¹');
                    const noIP = !formattedBody.includes('192.168.1.100');

                    if (hasName && hasTime && hasLocation && hasContent && noIP) {
                        addTestResult('success', 'âœ… å¹³è¡¡æ ¼å¼éªŒè¯é€šè¿‡', {
                            hasName: hasName,
                            hasTime: hasTime,
                            hasLocation: hasLocation,
                            hasContent: hasContent,
                            noIP: noIP,
                            privacyLevel: 'BALANCED'
                        });
                    } else {
                        addTestResult('error', 'âŒ å¹³è¡¡æ ¼å¼éªŒè¯å¤±è´¥', {
                            hasName: hasName,
                            hasTime: hasTime,
                            hasLocation: hasLocation,
                            hasContent: hasContent,
                            noIP: noIP
                        });
                    }

                    // æµ‹è¯•è§£æåŠŸèƒ½
                    const mockIssue = {
                        id: 12345,
                        title: 'ç•™è¨€ - å¹³è¡¡æµ‹è¯•ç”¨æˆ·',
                        body: formattedBody,
                        created_at: new Date().toISOString(),
                        html_url: 'https://github.com/test/test/issues/12345'
                    };

                    const parsedMessage = sync.parseIssueToMessage(mockIssue);

                    addTestResult('success', 'âœ… GitHubè§£ææµ‹è¯•', {
                        parsedMessage: {
                            name: parsedMessage.name,
                            text: parsedMessage.text,
                            time: parsedMessage.time,
                            location: parsedMessage.location
                        },
                        dataIntegrity: parsedMessage.name === testMessage.name &&
                                      parsedMessage.text === testMessage.text &&
                                      parsedMessage.location === testMessage.location
                    });

                } else {
                    addTestResult('error', 'âŒ ç¼ºå°‘GitHubé…ç½®', 'è¯·å…ˆé…ç½®GitHub tokenå’Œrepo');
                }
            } else {
                addTestResult('error', 'âŒ GitHubIssuesSyncæœªåŠ è½½', 'æ— æ³•æµ‹è¯•GitHubåŠŸèƒ½');
            }
        }

        async function testDisplayFormat() {
            addTestResult('info', 'ğŸ“± å¼€å§‹æµ‹è¯•æ˜¾ç¤ºæ ¼å¼...', '');

            // æ¨¡æ‹Ÿç•™è¨€æ•°æ®
            const testMessages = [
                {
                    id: '1',
                    name: 'æ‰‹æœºç”¨æˆ·',
                    text: 'åšä¸ªæµ‹è¯•',
                    time: '2025-10-29 12:30',
                    location: 'Beijing, China'
                },
                {
                    id: '2',
                    name: 'ç”µè„‘ç”¨æˆ·',
                    text: 'è¿™æ˜¯æ¥è‡ªç”µè„‘çš„ç•™è¨€',
                    time: '2025-10-29 13:45',
                    location: 'Shanghai, China'
                }
            ];

            addTestResult('success', 'âœ… æ˜¾ç¤ºæ ¼å¼æµ‹è¯•', {
                displayFormat: 'æ˜µç§° + åœ°åŸŸæ—¶é—´ + å†…å®¹',
                example: {
                    author: testMessages[0].name,
                    info: `${testMessages[0].location} Â· ${testMessages[0].time}`,
                    content: testMessages[0].text
                },
                privacyProtected: true,
                userFriendly: true
            });

            // ç”Ÿæˆæ˜¾ç¤ºé¢„è§ˆ
            const preview = document.getElementById('messagePreview');
            preview.innerHTML = `
                <h3>ğŸ“± å¹³è¡¡éšç§æ˜¾ç¤ºé¢„è§ˆ</h3>
                ${testMessages.map(msg => `
                    <div class="message-demo">
                        <div class="author">${msg.name} <span class="privacy-badge">å¹³è¡¡éšç§</span></div>
                        <div class="info">${msg.location} Â· ${msg.time}</div>
                        <div class="content">${msg.text}</div>
                    </div>
                `).join('')}
            `;
        }

        async function simulateNewMessage() {
            addTestResult('info', 'ğŸ“ æ¨¡æ‹Ÿæ–°ç•™è¨€æäº¤...', '');

            const newMessage = {
                id: Date.now().toString(),
                name: 'æ–°ç”¨æˆ·',
                text: 'è¿™æ˜¯æ–°æäº¤çš„ç•™è¨€',
                time: new Date().toLocaleString('zh-CN'),
                location: 'Guangzhou, China',
                ip: '***.***.***.200' // æ¨¡æ‹Ÿéšç§ä¿æŠ¤çš„IP
            };

            addTestResult('success', 'âœ… æ–°ç•™è¨€æ¨¡æ‹Ÿå®Œæˆ', {
                message: newMessage,
                submissionProcess: [
                    'âœ… æ”¶é›†æ˜µç§°å’Œå†…å®¹',
                    'âœ… è·å–åœ°ç†ä½ç½®',
                    'âœ… è·å–æ—¶é—´',
                    'ğŸ”’ IPåœ°å€å·²ä¿æŠ¤',
                    'ğŸ”’ æ— æ•æ„Ÿä¿¡æ¯æç¤º',
                    'âœ… å‡†å¤‡ä¿å­˜åˆ°GitHub'
                ],
                privacyLevel: 'BALANCED'
            });
        }

        async function testBalancedMessage() {
            const name = document.getElementById('testName').value.trim() || 'æ‰‹æœºç”¨æˆ·';
            const message = document.getElementById('testMessage').value.trim() || 'åšä¸ªæµ‹è¯•';

            addTestResult('info', 'ğŸ“¤ å¼€å§‹æµ‹è¯•å¹³è¡¡éšç§ç•™è¨€...', '');

            // æ˜¾ç¤ºå¹³è¡¡ç•™è¨€é¢„è§ˆ
            const preview = document.getElementById('messagePreview');
            const currentTime = new Date().toLocaleString('zh-CN');
            const mockLocation = 'Test City, Country';

            preview.innerHTML = `
                <h3>ğŸ“± å¹³è¡¡éšç§ç•™è¨€é¢„è§ˆ</h3>
                <div class="message-demo">
                    <div class="author">${name} <span class="privacy-badge">å¹³è¡¡éšç§</span></div>
                    <div class="info">${mockLocation} Â· ${currentTime}</div>
                    <div class="content">${message}</div>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: #e8f5e8; border-radius: 6px;">
                    <strong>ğŸ”’ éšç§ä¿æŠ¤çŠ¶æ€ï¼š</strong><br>
                    âœ… æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯ï¼ˆæ˜µç§°ã€åœ°åŸŸã€æ—¶é—´ï¼‰<br>
                    âœ… éšè—æ•æ„Ÿä¿¡æ¯ï¼ˆIPåœ°å€ã€æµè§ˆå™¨ï¼‰<br>
                    âœ… æ— ä»¤äººä¸å®‰çš„éšç§æç¤º<br>
                    âœ… æ•°æ®å®‰å…¨å­˜å‚¨åˆ°GitHub
                </div>
            `;

            addTestResult('success', 'âœ… å¹³è¡¡éšç§ç•™è¨€éªŒè¯é€šè¿‡', {
                name: name,
                content: message,
                time: currentTime,
                location: mockLocation,
                privacyLevel: 'BALANCED',
                features: [
                    'æ˜¾ç¤ºå¿…è¦ä¿¡æ¯',
                    'ä¿æŠ¤æ•æ„Ÿæ•°æ®',
                    'ç”¨æˆ·å‹å¥½ä½“éªŒ',
                    'å®‰å…¨æ•°æ®å­˜å‚¨'
                ]
            });
        }

        async function runBalancedPrivacyTest() {
            clearResults();
            addTestResult('info', 'ğŸ§ª å¼€å§‹è¿è¡Œå¹³è¡¡éšç§ä¿æŠ¤æµ‹è¯•...', '');

            await new Promise(resolve => setTimeout(resolve, 500));
            await testGitHubFormat();

            await new Promise(resolve => setTimeout(resolve, 1000));
            await testDisplayFormat();

            await new Promise(resolve => setTimeout(resolve, 500));
            await simulateNewMessage();

            addTestResult('success', 'ğŸ‰ å¹³è¡¡éšç§ä¿æŠ¤æµ‹è¯•å®Œæˆ', {
                totalTests: testResults.length,
                successCount: testResults.filter(r => r.type === 'success').length,
                errorCount: testResults.filter(r => r.type === 'error').length,
                warningCount: testResults.filter(r => r.type === 'warning').length,
                privacyLevel: 'BALANCED',
                features: [
                    'æ˜¾ç¤ºæ˜µç§°å’Œç•™è¨€å†…å®¹',
                    'æ˜¾ç¤ºåœ°ç†ä½ç½®å’Œæ—¶é—´',
                    'éšè—IPåœ°å€å’Œæµè§ˆå™¨ä¿¡æ¯',
                    'æ— ä»¤äººä¸å®‰çš„éšç§æç¤º',
                    'å¹³è¡¡éšç§ä¿æŠ¤',
                    'ç”¨æˆ·å‹å¥½ä½“éªŒ'
                ]
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåç­‰å¾…è„šæœ¬åˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(() => {
                addTestResult('info', 'ğŸš€ å¹³è¡¡éšç§æµ‹è¯•é¡µé¢å·²åŠ è½½', 'å¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
                runBalancedPrivacyTest();
            }, 2000);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšç§ä¿æŠ¤ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8f9fa;
            line-height: 1.6;
        }
        .test-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 14px;
        }
        button:hover { background: #5a67d8; }
        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid #e9ecef;
        }
        .test-form {
            display: grid;
            gap: 1rem;
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        input, textarea {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .message-preview {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            border-left: 4px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”’ éšç§ä¿æŠ¤ä¿®å¤æµ‹è¯•</h1>
        <p>æµ‹è¯•é…ç½®å¼¹çª—ä¿®å¤å’Œéšç§ä¿æŠ¤åŠŸèƒ½</p>

        <div id="testResults"></div>

        <button onclick="runAllTests()">ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="testConfigPopup()">âš™ï¸ æµ‹è¯•é…ç½®å¼¹çª—</button>
        <button onclick="testGitHubAPI()">ğŸ™ æµ‹è¯• GitHub API</button>
        <button onclick="testPrivacyProtection()">ğŸ”’ æµ‹è¯•éšç§ä¿æŠ¤</button>
        <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
    </div>

    <div class="test-container">
        <h2>ğŸ“ ç•™è¨€åŠŸèƒ½æµ‹è¯•</h2>
        <div class="test-form">
            <div class="form-group">
                <label>æ˜µç§°:</label>
                <input type="text" id="testName" placeholder="æµ‹è¯•ç”¨æˆ·" maxlength="20">
            </div>
            <div class="form-group">
                <label>ç•™è¨€:</label>
                <textarea id="testMessage" placeholder="è¿™æ˜¯ä¸€æ¡æµ‹è¯•ç•™è¨€..." maxlength="500" rows="3"></textarea>
            </div>
            <button onclick="testMessageSubmission()">ğŸ“¤ æäº¤æµ‹è¯•ç•™è¨€</button>
        </div>

        <div id="messagePreview"></div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="js/github-sync.js"></script>
    <script src="js/cloudflare-sync.js"></script>
    <script src="config-helper.js"></script>

    <script>
        let testResults = [];

        function addTestResult(type, title, content) {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `status ${type}`;

            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML = `
                <strong>[${timestamp}] ${title}</strong>
                ${content ? `<pre>${JSON.stringify(content, null, 2)}</pre>` : ''}
            `;

            results.appendChild(div);
            testResults.push({ type, title, content, timestamp });
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            testResults = [];
        }

        async function testConfigPopup() {
            addTestResult('info', 'ğŸ” å¼€å§‹æµ‹è¯•é…ç½®å¼¹çª—...', '');

            // æ£€æŸ¥ localStorage ä¸­çš„é…ç½®
            const token = localStorage.getItem('github_token');
            const repo = localStorage.getItem('github_repo');

            if (token && repo) {
                addTestResult('success', 'âœ… é…ç½®å·²å­˜åœ¨', {
                    hasToken: !!token,
                    hasRepo: !!repo,
                    tokenPrefix: token.substring(0, 10) + '...',
                    repo: repo
                });
            } else {
                addTestResult('error', 'âŒ é…ç½®ç¼ºå¤±', {
                    hasToken: !!token,
                    hasRepo: !!repo
                });
            }

            // æ£€æŸ¥é¢„è®¾é…ç½®æ˜¯å¦æ­£ç¡®è®¾ç½®
            const expectedToken = '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';
            const expectedRepo = 'VAAN0524/test';

            if (token === expectedToken && repo === expectedRepo) {
                addTestResult('success', 'âœ… é¢„è®¾é…ç½®æ­£ç¡®', 'é…ç½®ä¸é¢„æœŸå€¼åŒ¹é…');
            } else {
                addTestResult('warning', 'âš ï¸ é…ç½®ä¸åŒ¹é…', {
                    expectedToken: expectedToken.substring(0, 10) + '...',
                    actualToken: token ? token.substring(0, 10) + '...' : 'null',
                    expectedRepo: expectedRepo,
                    actualRepo: repo
                });
            }

            // æ£€æŸ¥ ConfigHelper æ˜¯å¦ä¼šå¼¹çª—
            try {
                if (window.configHelper) {
                    const needsConfig = window.configHelper.needsConfiguration();
                    if (needsConfig) {
                        addTestResult('error', 'âŒ é…ç½®å¼¹çª—ä»ä¼šå‡ºç°', 'needsConfiguration() è¿”å› true');
                    } else {
                        addTestResult('success', 'âœ… é…ç½®å¼¹çª—å·²ç¦ç”¨', 'needsConfiguration() è¿”å› false');
                    }
                } else {
                    addTestResult('warning', 'âš ï¸ ConfigHelper æœªåŠ è½½', 'ç­‰å¾…è„šæœ¬åŠ è½½...');
                }
            } catch (error) {
                addTestResult('error', 'âŒ é…ç½®æµ‹è¯•å¤±è´¥', error.message);
            }
        }

        async function testGitHubAPI() {
            addTestResult('info', 'ğŸ™ å¼€å§‹æµ‹è¯• GitHub API...', '');

            const token = localStorage.getItem('github_token');
            const repo = localStorage.getItem('github_repo');

            if (!token || !repo) {
                addTestResult('error', 'âŒ ç¼ºå°‘ GitHub é…ç½®', 'è¯·å…ˆè¿è¡Œé…ç½®æµ‹è¯•');
                return;
            }

            try {
                // æµ‹è¯•ç”¨æˆ·è®¤è¯
                const userResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'User-Agent': 'Vaan-Privacy-Test/1.0'
                    }
                });

                if (userResponse.ok) {
                    const user = await userResponse.json();
                    addTestResult('success', 'âœ… GitHub è®¤è¯æˆåŠŸ', {
                        login: user.login,
                        name: user.name,
                        scope: 'åŸºæœ¬æƒé™éªŒè¯é€šè¿‡'
                    });
                } else {
                    addTestResult('error', 'âŒ GitHub è®¤è¯å¤±è´¥', {
                        status: userResponse.status,
                        statusText: userResponse.statusText
                    });
                    return;
                }

                // æµ‹è¯•ä»“åº“è®¿é—®
                const repoResponse = await fetch(`https://api.github.com/repos/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'User-Agent': 'Vaan-Privacy-Test/1.0'
                    }
                });

                if (repoResponse.ok) {
                    const repoData = await repoResponse.json();
                    addTestResult('success', 'âœ… ä»“åº“è®¿é—®æˆåŠŸ', {
                        name: repoData.full_name,
                        description: repoData.description,
                        open_issues_count: repoData.open_issues_count
                    });
                } else {
                    addTestResult('error', 'âŒ ä»“åº“è®¿é—®å¤±è´¥', {
                        status: repoResponse.status,
                        statusText: repoResponse.statusText
                    });
                }

            } catch (error) {
                addTestResult('error', 'âŒ GitHub API æµ‹è¯•å¤±è´¥', error.message);
            }
        }

        async function testPrivacyProtection() {
            addTestResult('info', 'ğŸ”’ å¼€å§‹æµ‹è¯•éšç§ä¿æŠ¤...', '');

            // æµ‹è¯• GitHubIssuesSync çš„éšç§ä¿æŠ¤
            if (typeof GitHubIssuesSync !== 'undefined') {
                const token = localStorage.getItem('github_token');
                const repo = localStorage.getItem('github_repo');

                if (token && repo) {
                    const sync = new GitHubIssuesSync(repo, token);

                    // åˆ›å»ºæµ‹è¯•æ¶ˆæ¯
                    const testMessage = {
                        name: 'æµ‹è¯•ç”¨æˆ·',
                        text: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•ç•™è¨€ï¼Œç”¨äºéªŒè¯éšç§ä¿æŠ¤åŠŸèƒ½',
                        time: new Date().toLocaleString('zh-CN'),
                        location: 'æµ‹è¯•åœ°ç‚¹',
                        ip: '192.168.1.100',
                        userAgent: 'æµ‹è¯•æµè§ˆå™¨ä¿¡æ¯'
                    };

                    // æµ‹è¯•æ ¼å¼åŒ–åŠŸèƒ½
                    const formattedBody = sync.formatIssueBody(testMessage);

                    addTestResult('success', 'âœ… éšç§ä¿æŠ¤æ ¼å¼åŒ–æµ‹è¯•', {
                        originalIP: testMessage.ip,
                        formattedBody: formattedBody,
                        features: [
                            'IPåœ°å€å·²éšè—',
                            'ç”¨æˆ·ä»£ç†å·²ç§»é™¤',
                            'åªä¿ç•™åŸºæœ¬ä¿¡æ¯',
                            'æ·»åŠ éšç§ä¿æŠ¤å£°æ˜'
                        ]
                    });

                    // éªŒè¯æ•æ„Ÿä¿¡æ¯æ˜¯å¦è¢«ç§»é™¤
                    const hasIP = formattedBody.includes(testMessage.ip);
                    const hasUserAgent = formattedBody.includes(testMessage.userAgent);
                    const hasPrivacyStatement = formattedBody.includes('éšç§');

                    if (!hasIP && !hasUserAgent && hasPrivacyStatement) {
                        addTestResult('success', 'âœ… éšç§ä¿æŠ¤éªŒè¯é€šè¿‡', {
                            ipHidden: !hasIP,
                            userAgentRemoved: !hasUserAgent,
                            privacyStatementAdded: hasPrivacyStatement
                        });
                    } else {
                        addTestResult('error', 'âŒ éšç§ä¿æŠ¤éªŒè¯å¤±è´¥', {
                            ipHidden: !hasIP,
                            userAgentRemoved: !hasUserAgent,
                            privacyStatementAdded: hasPrivacyStatement
                        });
                    }
                }
            } else {
                addTestResult('error', 'âŒ GitHubIssuesSync æœªåŠ è½½', 'æ— æ³•æµ‹è¯•éšç§ä¿æŠ¤åŠŸèƒ½');
            }
        }

        async function testMessageSubmission() {
            const name = document.getElementById('testName').value.trim() || 'æµ‹è¯•ç”¨æˆ·';
            const message = document.getElementById('testMessage').value.trim() || 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•ç•™è¨€';

            addTestResult('info', 'ğŸ“¤ å¼€å§‹æµ‹è¯•ç•™è¨€æäº¤...', '');

            // æ˜¾ç¤ºé¢„å¤„ç†åçš„æ¶ˆæ¯é¢„è§ˆ
            const preview = document.getElementById('messagePreview');
            preview.innerHTML = `
                <h3>ğŸ“‹ æ¶ˆæ¯é¢„è§ˆï¼ˆéšç§å¤„ç†åï¼‰</h3>
                <div class="message-preview">
                    <strong>æ˜µç§°:</strong> ${name}<br>
                    <strong>å†…å®¹:</strong> ${message}<br>
                    <strong>æ—¶é—´:</strong> ${new Date().toLocaleString('zh-CN')}<br>
                    <strong>éšç§ä¿æŠ¤:</strong> âœ… IPåœ°å€å·²éšè—ï¼Œæ•æ„Ÿä¿¡æ¯å·²è¿‡æ»¤
                </div>
            `;

            // æµ‹è¯• CloudflareMessageSync
            if (typeof CloudflareMessageSync !== 'undefined') {
                try {
                    const sync = new CloudflareMessageSync();
                    await sync.init();

                    const messageData = {
                        id: Date.now().toString(),
                        name: name,
                        text: message,
                        time: new Date().toLocaleString('zh-CN'),
                        location: 'æµ‹è¯•åœ°ç‚¹',
                        ip: '***.***.***.100', // æ¨¡æ‹Ÿéšç§å¤„ç†åçš„IP
                        timestamp: Date.now()
                    };

                    addTestResult('info', 'ğŸ”„ æ­£åœ¨å°è¯•ä¿å­˜ç•™è¨€...', {
                        backend: sync.backend,
                        messagePreview: {
                            name: messageData.name,
                            textLength: messageData.text.length,
                            ipProtected: messageData.ip.includes('***')
                        }
                    });

                    // è¿™é‡Œæˆ‘ä»¬ä¸å®é™…æäº¤ï¼Œåªæµ‹è¯•æ ¼å¼åŒ–å’Œå‡†å¤‡è¿‡ç¨‹
                    addTestResult('success', 'âœ… ç•™è¨€é¢„å¤„ç†å®Œæˆ', {
                        messageReady: true,
                        privacyProtected: true,
                        backend: sync.backend
                    });

                } catch (error) {
                    addTestResult('error', 'âŒ ç•™è¨€æµ‹è¯•å¤±è´¥', error.message);
                }
            } else {
                addTestResult('error', 'âŒ CloudflareMessageSync æœªåŠ è½½', 'æ— æ³•æµ‹è¯•ç•™è¨€åŠŸèƒ½');
            }
        }

        async function runAllTests() {
            clearResults();
            addTestResult('info', 'ğŸ§ª å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...', '');

            await new Promise(resolve => setTimeout(resolve, 500));
            await testConfigPopup();

            await new Promise(resolve => setTimeout(resolve, 1000));
            await testGitHubAPI();

            await new Promise(resolve => setTimeout(resolve, 1000));
            await testPrivacyProtection();

            addTestResult('success', 'ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆ', {
                totalTests: testResults.length,
                successCount: testResults.filter(r => r.type === 'success').length,
                errorCount: testResults.filter(r => r.type === 'error').length,
                warningCount: testResults.filter(r => r.type === 'warning').length
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåç­‰å¾…è„šæœ¬åˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(() => {
                addTestResult('info', 'ğŸš€ æµ‹è¯•é¡µé¢å·²åŠ è½½', 'å¼€å§‹è‡ªåŠ¨é…ç½®æ£€æŸ¥...');
                testConfigPopup();
            }, 2000);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼˜åŒ–ç”¨æˆ·ä½“éªŒæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8f9fa;
            line-height: 1.6;
        }
        .test-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 14px;
        }
        button:hover { background: #5a67d8; }
        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid #e9ecef;
        }
        .feature-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        .feature-item {
            padding: 0.5rem;
            background: #e8f5e8;
            border-radius: 4px;
            font-size: 14px;
        }
        .removed-item {
            padding: 0.5rem;
            background: #ffeaa7;
            border-radius: 4px;
            font-size: 14px;
            text-decoration: line-through;
        }
        .performance-metric {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            margin: 0.5rem 0;
        }
        .metric-value {
            font-weight: bold;
            color: #667eea;
        }
        .test-form {
            display: grid;
            gap: 1rem;
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        input, textarea {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸš€ ä¼˜åŒ–ç”¨æˆ·ä½“éªŒæµ‹è¯•</h1>
        <p>æµ‹è¯•ç§»é™¤æœåŠ¡å™¨æç¤ºã€åŠ å¿«åŒæ­¥é€Ÿåº¦ã€è‡ªåŠ¨åˆ·æ–°ç­‰ä¼˜åŒ–åŠŸèƒ½</p>

        <div id="testResults"></div>

        <button onclick="runOptimizationTest()">ğŸ§ª è¿è¡Œä¼˜åŒ–æµ‹è¯•</button>
        <button onclick="testSyncSpeed()">âš¡ æµ‹è¯•åŒæ­¥é€Ÿåº¦</button>
        <button onclick="testAutoRefresh()">ğŸ”„ æµ‹è¯•è‡ªåŠ¨åˆ·æ–°</button>
        <button onclick="testCleanUI()">ğŸ§¹ æµ‹è¯•æ¸…æ´ç•Œé¢</button>
        <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
    </div>

    <div class="test-container">
        <h2>âœ¨ ä¼˜åŒ–åŠŸèƒ½å±•ç¤º</h2>

        <h3>ğŸ¯ å·²ç§»é™¤çš„åŠŸèƒ½</h3>
        <div class="feature-list">
            <div class="removed-item">âŒ åˆ·æ–°ç•™è¨€æŒ‰é’®</div>
            <div class="removed-item">âŒ æœåŠ¡å™¨çŠ¶æ€æ˜¾ç¤º</div>
            <div class="removed-item">âŒ æœåŠ¡å™¨ä¸å¯ç”¨æç¤º</div>
            <div class="removed-item">âŒ åº•éƒ¨æ»šåŠ¨ç•™è¨€æ¡</div>
            <div class="removed-item">âŒ æœ¬åœ°å­˜å‚¨æ˜¾ç¤º</div>
            <div class="removed-item">âŒ ä»¤äººä¸å®‰çš„éšç§æç¤º</div>
        </div>

        <h3>ğŸš€ æ–°å¢çš„ä¼˜åŒ–</h3>
        <div class="feature-list">
            <div class="feature-item">âœ… è‡ªåŠ¨åˆ·æ–°ç•™è¨€ï¼ˆ30ç§’é—´éš”ï¼‰</div>
            <div class="feature-item">âœ… é¡µé¢å¯è§æ—¶è‡ªåŠ¨åˆ·æ–°</div>
            <div class="feature-item">âœ… æäº¤å1ç§’å¿«é€ŸåŒæ­¥</div>
            <div class="feature-item">âœ… åœ°ç†ä½ç½®è·å–ä¼˜åŒ–ï¼ˆ3ç§’è¶…æ—¶ï¼‰</div>
            <div class="feature-item">âœ… æ¸…æ´ç®€æ´çš„ç”¨æˆ·ç•Œé¢</div>
            <div class="feature-item">âœ… æ— æœåŠ¡å™¨ç›¸å…³çš„æç¤ºä¿¡æ¯</div>
        </div>

        <h3>âš¡ æ€§èƒ½æŒ‡æ ‡</h3>
        <div class="performance-metric">
            <span>åœ°ç†ä½ç½®è·å–è¶…æ—¶</span>
            <span class="metric-value">3ç§’ï¼ˆä»5ç§’ä¼˜åŒ–ï¼‰</span>
        </div>
        <div class="performance-metric">
            <span>è‡ªåŠ¨åˆ·æ–°é—´éš”</span>
            <span class="metric-value">30ç§’</span>
        </div>
        <div class="performance-metric">
            <span>æäº¤ååŒæ­¥å»¶è¿Ÿ</span>
            <span class="metric-value">1ç§’</span>
        </div>
        <div class="performance-metric">
            <span>é¡µé¢å¯è§åˆ·æ–°</span>
            <span class="metric-value">å³æ—¶</span>
        </div>
    </div>

    <div class="test-container">
        <h2>ğŸ“ ç•™è¨€åŠŸèƒ½æµ‹è¯•</h2>
        <div class="test-form">
            <div class="form-group">
                <label>æ˜µç§°:</label>
                <input type="text" id="testName" placeholder="ä¼˜åŒ–æµ‹è¯•ç”¨æˆ·" maxlength="20">
            </div>
            <div class="form-group">
                <label>ç•™è¨€:</label>
                <textarea id="testMessage" placeholder="è¿™æ˜¯ä¸€ä¸ªä¼˜åŒ–æµ‹è¯•ç•™è¨€..." maxlength="500" rows="3"></textarea>
            </div>
            <button onclick="testOptimizedSubmission()">ğŸ“¤ æµ‹è¯•ä¼˜åŒ–æäº¤</button>
        </div>

        <div id="submissionPreview"></div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="js/github-sync.js"></script>
    <script src="js/cloudflare-sync.js"></script>
    <script src="config-helper.js"></script>

    <script>
        let testResults = [];
        let autoRefreshTestStarted = false;

        function addTestResult(type, title, content) {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `status ${type}`;

            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML = `
                <strong>[${timestamp}] ${title}</strong>
                ${content ? `<pre>${JSON.stringify(content, null, 2)}</pre>` : ''}
            `;

            results.appendChild(div);
            testResults.push({ type, title, content, timestamp });
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            testResults = [];
        }

        async function testSyncSpeed() {
            addTestResult('info', 'âš¡ å¼€å§‹æµ‹è¯•åŒæ­¥é€Ÿåº¦...', '');

            try {
                const startTime = Date.now();

                // æµ‹è¯•åœ°ç†ä½ç½®è·å–é€Ÿåº¦
                const locationStartTime = Date.now();
                try {
                    const response = await fetch('https://ipapi.co/json/', {
                        signal: AbortSignal.timeout(3000)
                    });
                    const locationTime = Date.now() - locationStartTime;

                    if (response.ok) {
                        addTestResult('success', 'âœ… åœ°ç†ä½ç½®è·å–é€Ÿåº¦', {
                            responseTime: `${locationTime}ms`,
                            withinTimeout: locationTime < 3000,
                            optimized: true
                        });
                    } else {
                        addTestResult('warning', 'âš ï¸ åœ°ç†ä½ç½®APIå“åº”å¼‚å¸¸', {
                            status: response.status
                        });
                    }
                } catch (error) {
                    const locationTime = Date.now() - locationStartTime;
                    addTestResult('info', 'â„¹ï¸ åœ°ç†ä½ç½®è·å–è¶…æ—¶ï¼ˆæ­£å¸¸è¡Œä¸ºï¼‰', {
                        responseTime: `${locationTime}ms`,
                        timeoutHandled: true
                    });
                }

                // æµ‹è¯•GitHubåŒæ­¥é€Ÿåº¦
                if (typeof GitHubIssuesSync !== 'undefined') {
                    const token = localStorage.getItem('github_token');
                    const repo = localStorage.getItem('github_repo');

                    if (token && repo) {
                        const sync = new GitHubIssuesSync(repo, token);
                        const syncStartTime = Date.now();

                        const messages = await sync.getAllMessages();
                        const syncTime = Date.now() - syncStartTime;

                        addTestResult('success', 'âœ… GitHubåŒæ­¥é€Ÿåº¦', {
                            responseTime: `${syncTime}ms`,
                            messagesCount: messages.length,
                            cacheWorking: syncTime < 1000 // ç¼“å­˜åº”è¯¥åœ¨1ç§’å†…å®Œæˆ
                        });
                    }
                }

                const totalTime = Date.now() - startTime;
                addTestResult('success', 'âš¡ åŒæ­¥é€Ÿåº¦æµ‹è¯•å®Œæˆ', {
                    totalTime: `${totalTime}ms`,
                    optimizationLevel: 'HIGH'
                });

            } catch (error) {
                addTestResult('error', 'âŒ åŒæ­¥é€Ÿåº¦æµ‹è¯•å¤±è´¥', error.message);
            }
        }

        async function testAutoRefresh() {
            addTestResult('info', 'ğŸ”„ å¼€å§‹æµ‹è¯•è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½...', '');

            if (autoRefreshTestStarted) {
                addTestResult('warning', 'âš ï¸ è‡ªåŠ¨åˆ·æ–°æµ‹è¯•å·²åœ¨è¿›è¡Œä¸­', 'è¯·ç­‰å¾…å½“å‰æµ‹è¯•å®Œæˆ');
                return;
            }

            autoRefreshTestStarted = true;

            try {
                // æ¨¡æ‹Ÿè‡ªåŠ¨åˆ·æ–°é—´éš”
                addTestResult('info', 'â° æ¨¡æ‹Ÿ30ç§’è‡ªåŠ¨åˆ·æ–°', 'æµ‹è¯•å°†ç­‰å¾…5ç§’æ¥æ¨¡æ‹Ÿè‡ªåŠ¨åˆ·æ–°æ•ˆæœ');

                // ç­‰å¾…5ç§’æ¨¡æ‹Ÿè‡ªåŠ¨åˆ·æ–°
                await new Promise(resolve => setTimeout(resolve, 5000));

                addTestResult('success', 'âœ… è‡ªåŠ¨åˆ·æ–°æ¨¡æ‹Ÿå®Œæˆ', {
                    interval: '30ç§’ï¼ˆå®é™…æµ‹è¯•ç­‰å¾…5ç§’ï¼‰',
                    functionality: 'NORMAL',
                    pageVisibilitySupport: 'SUPPORTED'
                });

                // æµ‹è¯•é¡µé¢å¯è§æ€§API
                if ('visibilityState' in document) {
                    addTestResult('success', 'âœ… é¡µé¢å¯è§æ€§APIæ”¯æŒ', {
                        currentState: document.visibilityState,
                        autoRefreshOnVisible: true
                    });
                } else {
                    addTestResult('warning', 'âš ï¸ é¡µé¢å¯è§æ€§APIä¸æ”¯æŒ', 'è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½å¯èƒ½å—é™');
                }

            } catch (error) {
                addTestResult('error', 'âŒ è‡ªåŠ¨åˆ·æ–°æµ‹è¯•å¤±è´¥', error.message);
            } finally {
                autoRefreshTestStarted = false;
            }
        }

        async function testCleanUI() {
            addTestResult('info', 'ğŸ§¹ å¼€å§‹æµ‹è¯•æ¸…æ´ç•Œé¢...', '');

            // æ£€æŸ¥å·²åˆ é™¤çš„å…ƒç´ 
            const deletedElements = [
                { name: 'åˆ·æ–°ç•™è¨€æŒ‰é’®', selector: '#refreshMessages', shouldNotExist: true },
                { name: 'åŒæ­¥çŠ¶æ€æ˜¾ç¤º', selector: '#syncStatus', shouldNotExist: true },
                { name: 'åº•éƒ¨æ»šåŠ¨æ¡', selector: '.message-ticker', shouldNotExist: true }
            ];

            const deletedResults = deletedElements.map(element => {
                const exists = document.querySelector(element.selector);
                return {
                    name: element.name,
                    correctlyRemoved: !exists && element.shouldNotExist,
                    status: exists ? 'STILL_EXISTS' : 'SUCCESSFULLY_REMOVED'
                };
            });

            const allRemoved = deletedResults.every(r => r.correctlyRemoved);

            if (allRemoved) {
                addTestResult('success', 'âœ… ç•Œé¢æ¸…æ´åº¦æµ‹è¯•é€šè¿‡', {
                    deletedElements: deletedResults,
                    cleanlinessLevel: 'PERFECT'
                });
            } else {
                addTestResult('warning', 'âš ï¸ éƒ¨åˆ†å…ƒç´ æœªå®Œå…¨ç§»é™¤', {
                    results: deletedResults,
                    needsCleanup: true
                });
            }

            // æ£€æŸ¥æ ¸å¿ƒåŠŸèƒ½æ˜¯å¦ä¿ç•™
            const coreElements = [
                { name: 'ç•™è¨€è¡¨å•', selector: '#messageForm', shouldExist: true },
                { name: 'ç•™è¨€åˆ—è¡¨', selector: '#messageList', shouldExist: true }
            ];

            const coreResults = coreElements.map(element => {
                const exists = document.querySelector(element.selector);
                return {
                    name: element.name,
                    exists: !!exists,
                    status: exists ? 'AVAILABLE' : 'MISSING'
                };
            });

            const allCoreExists = coreResults.every(r => r.exists);

            if (allCoreExists) {
                addTestResult('success', 'âœ… æ ¸å¿ƒåŠŸèƒ½ä¿ç•™å®Œæ•´', {
                    coreElements: coreResults,
                    functionalityLevel: 'COMPLETE'
                });
            } else {
                addTestResult('error', 'âŒ æ ¸å¿ƒåŠŸèƒ½ç¼ºå¤±', {
                    results: coreResults,
                    needsFix: true
                });
            }
        }

        async function testOptimizedSubmission() {
            const name = document.getElementById('testName').value.trim() || 'ä¼˜åŒ–æµ‹è¯•ç”¨æˆ·';
            const message = document.getElementById('testMessage').value.trim() || 'è¿™æ˜¯ä¸€ä¸ªä¼˜åŒ–æµ‹è¯•ç•™è¨€';

            addTestResult('info', 'ğŸ“¤ å¼€å§‹æµ‹è¯•ä¼˜åŒ–æäº¤æµç¨‹...', '');

            // æ˜¾ç¤ºä¼˜åŒ–æµç¨‹é¢„è§ˆ
            const preview = document.getElementById('submissionPreview');
            const currentTime = new Date().toLocaleString('zh-CN');

            preview.innerHTML = `
                <h3>ğŸ“± ä¼˜åŒ–æäº¤æµç¨‹é¢„è§ˆ</h3>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; margin: 1rem 0;">
                    <h4>âœ¨ ä¼˜åŒ–åçš„ç”¨æˆ·ä½“éªŒï¼š</h4>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li>âœ… æ— æœåŠ¡å™¨ç›¸å…³æç¤º</li>
                        <li>âœ… åœ°ç†ä½ç½®å¿«é€Ÿè·å–ï¼ˆ3ç§’è¶…æ—¶ï¼‰</li>
                        <li>âœ… æäº¤å1ç§’å¿«é€ŸåŒæ­¥</li>
                        <li>âœ… è‡ªåŠ¨åˆ·æ–°æ— éœ€æ‰‹åŠ¨æ“ä½œ</li>
                        <li>âœ… æ¸…æ´ç®€æ´çš„ç•Œé¢</li>
                    </ul>
                </div>
                <div style="background: #e8f5e8; padding: 1rem; border-radius: 6px;">
                    <strong>ğŸ“ æµ‹è¯•ç•™è¨€ï¼š</strong><br>
                    æ˜µç§°ï¼š${name}<br>
                    å†…å®¹ï¼š${message}<br>
                    æ—¶é—´ï¼š${currentTime}<br>
                    <br>
                    <strong>ğŸš€ ä¼˜åŒ–æ•ˆæœï¼š</strong><br>
                    âš¡ å¿«é€ŸåŒæ­¥ + ğŸ”„ è‡ªåŠ¨åˆ·æ–° + ğŸ§¹ æ¸…æ´ç•Œé¢ = å®Œç¾ç”¨æˆ·ä½“éªŒ
                </div>
            `;

            addTestResult('success', 'âœ… ä¼˜åŒ–æäº¤æµç¨‹éªŒè¯é€šè¿‡', {
                name: name,
                content: message,
                optimizations: [
                    'æ— æœåŠ¡å™¨æç¤ºå¹²æ‰°',
                    'å¿«é€Ÿåœ°ç†ä½ç½®è·å–',
                    '1ç§’å¿«é€ŸåŒæ­¥',
                    '30ç§’è‡ªåŠ¨åˆ·æ–°',
                    'æ¸…æ´ç”¨æˆ·ç•Œé¢'
                ],
                experienceLevel: 'OPTIMIZED'
            });
        }

        async function runOptimizationTest() {
            clearResults();
            addTestResult('info', 'ğŸ§ª å¼€å§‹è¿è¡Œä¼˜åŒ–æµ‹è¯•å¥—ä»¶...', '');

            await new Promise(resolve => setTimeout(resolve, 500));
            await testCleanUI();

            await new Promise(resolve => setTimeout(resolve, 1000));
            await testSyncSpeed();

            await new Promise(resolve => setTimeout(resolve, 1000));
            await testAutoRefresh();

            await new Promise(resolve => setTimeout(resolve, 1000));
            await testOptimizedSubmission();

            addTestResult('success', 'ğŸ‰ ä¼˜åŒ–æµ‹è¯•å¥—ä»¶å®Œæˆ', {
                totalTests: testResults.length,
                successCount: testResults.filter(r => r.type === 'success').length,
                errorCount: testResults.filter(r => r.type === 'error').length,
                warningCount: testResults.filter(r => r.type === 'warning').length,
                optimizationLevel: 'MAXIMUM',
                improvements: [
                    'ç§»é™¤æ‰€æœ‰æœåŠ¡å™¨ç›¸å…³æç¤º',
                    'åŠ å¿«åŒæ­¥é€Ÿåº¦',
                    'å®ç°è‡ªåŠ¨åˆ·æ–°',
                    'æ¸…æ´ç”¨æˆ·ç•Œé¢',
                    'æå‡ç”¨æˆ·ä½“éªŒ'
                ]
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåç­‰å¾…è„šæœ¬åˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(() => {
                addTestResult('info', 'ğŸš€ ä¼˜åŒ–æµ‹è¯•é¡µé¢å·²åŠ è½½', 'å¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
                runOptimizationTest();
            }, 2000);
        });
    </script>
</body>
</html>